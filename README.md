# NCBI taxonomic classifications from NCBI accession numbers (acc2taxo)

## Description
This Python script `acc2taxo.py` retrieves NCBI taxonomic information associated with a list of accession numbers in a text file. It generates a table with the NCBI taxonomic classification of each accession number. It can also generate a file containing the NCBI taxonomy tree corresponding to the retrieved taxids.

## Usage
The script can be executed from the command line as follows:


```shell
python3 acc2taxo.py -i input_file.txt -o output_file.txt [OPTIONS]
```

The following options are available:

- `-i/--input`: the input file containing one accession number per line (required)
- `-o/--output`: the output file name (required)
- `-db/--database`: the queried NCBI database (default is "protein")
- `--sep`: the column separator for the output table (default is ",")
- `--clean`: remove empty ranks in the final table (default)
- `--no-clean`: keep all ranks in the final table (overrides `--clean`)
- `--updatetaxodb`: update the local NCBI taxonomy database. Must be set when first using the script.Takes about 50 seconds to complete 
- `-t/--tree`: (optional) the file name where to write the NCBI taxonomy tree corresponding to the list of retrieved taxids
- `--verbose`: enable verbose mode (default)
- `-v/--version`: print the version of the script

## Requirements

The script requires Python 3 and the following modules:

- `argparse`
- `requests`
- `pandas`
- `ete3`

All these modules can be easily installed with pip: 
```shell
pip install module_name
```


## Workflow

The script proceeds in two (optionnaly three) steps:

1. Get taxids from accession numbers: reads the input file, retrieves the taxid associated with each accession number from the NCBI eutils API, querying the desired database with chunks of 200 IDs. Default database is set to **protein**. For a list of databases, see https://www.ncbi.nlm.nih.gov/books/NBK25497/table/chapter2.T._entrez_unique_identifiers_ui/?report=objectonly. Note that the script automatically pauses for 0.5 seconds between each eutils API query to comply with NCBI's requirements (max 3 queries/second without a key).
2. Get infos from taxids: retrieves the lineage and names of each taxid from the NCBI taxonomy database.
3. (optional) Get the tree from the list of unique taxids retrieved in step 2.

## Example

An example file `example-acc` is provided. 
It contains 2132 *GI numbers* that can easily be retrieved in the Protein NCBI database.

Calling it as follows: 

```shell
python3 acc2taxo.py -i example-acc -o acc-results.csv -db protein -t out.tre --clean
```
Generates a table, whose first columns and rows look like: 

| acc         | taxid | name                         | rank    | superkingdom | kingdom       | phylum           | ... |
|-------------|-------|------------------------------|---------|--------------|---------------|------------------|-----|
| NP_041191.1 | 58103 | Leishmania RNA virus 1 - 1   | no rank | Viruses      | Orthornavirae | Duplornaviricota | ... |
| NP_056808.1 | 12238 | Odontoglossum ringspot virus | species | Viruses      | Orthornavirae | Kitrinoviricota  | ... |
| NP_056810.1 | 12238 | Odontoglossum ringspot virus | species | Viruses      | Orthornavirae | Kitrinoviricota  | ... |
| ...         | ...   | ...                          | ...     | ...          | ...           | ...              | ... |

- **acc** is the identifier as given in the input file
- **taxid** is the associated NCBI taxid
- **name** is the name of the taxon
- **rank** is his rank
- **superkingdom**,**kingdom**,**phylum**, **...** are the ordered ranks of the full lineage associated to each taxid, going towards the deepest observed taxid in the table. 

The function above also produces a tree in Newick format containing the taxids present in the table as well as all taxids associated to all the nodes in the taxonomic tree. 

```shell
((((((((12288,12286,103782,12285,12287,1807813)143920,(35297,43761,43764,43763,683176)143919,(430911,222557,1807811)222556)12283,1983562)2732546,(((12295,12294,31750)12293,(12327,12328,44421)12326,(45103,100887,107804,2030954,83544,28375)12291,(368735,368736,1761477,35281,51680,1501716,29272,111418,1416026,388038,402399,31749,146499,1391702,(2200716,1979541)327386,228578,99585,425279,335187,111970,1123754,233051,185955,1169032,229030,1128119,327387,12235,12238,12239,12241,12242,12253)12234,(37128,71972,1758139,46436)186886,(2108200,2108201)1527522,(1647805,1920772)1920771)675071,((12317,37733,2169960,1637492,64958,339420,151043,747056,722755,243563,2755028,2116599)12316,(1195163,116056,1464778)413970,(188141,2052851)12300,12315,12321)39740,((55951,1381464)217160,1206566)69973,((2052685,347219)675070,(1094249,2419939)2022856,1513278)2560061)2732544,(((2560401,39443)12141,53181)2560077,2170591)2732548,(1983570,1807800)38144)2732406,((((((328061,649890,12260,12262,12263,392504)12258,1855510)675075,(1561160,1425364)675073,51354)675072,(1419327,2315763,1804154)324901,((1345662,1591444,1566869,1911104,2099521,1464786,1675864,2054920,1629132,1965238,1410467,1807798,2315809,1654357,1345661,1920698)1111709,((1487185,1972700,1958778,1936269,1690666,2018471,2358449,1432857,1906245)336476,12742,170621,1072333,232800,89463,458132,198112,1521188,1111710,1460071,1267585,2056384,436447,240555)232799)699189,(2099352,2108204,1813613,(1813615,1930509)2219049,1807792,1807805,(1105380,1105381)2219055,2315805,2315807,1795648,1654355,1926996)675074,((92395,103442,64698,2170238,81583)1922209,(92444,142102,932662,68876,294365,294369)1213379,((1769780,2005444)336633,209529,64279,66834,12136)144051,(2486713,1776109,1983569,1432856,1041883,1926967,1027947)336635)232795,(((172314,1294177)138954,(1401263,2870351)1914566,2170191,1293536,1398149)2946640,(2013564,1534547,1108810)478825,(((1233383,1582094)586424,2003650)586418,2003501)2946627,(((1987144,2766976)1987129,12092,1708572,1987139,1987145,1768064,1987143)12091,2058161)2946633,((1477515,2847848)2170006,(980964)1330070,2079598,1987722)1330069)12058,1871153)464095,((131082,(2019445,1913024,1564903,1913124,1913125,1972995,572239,1577997,1963256,1756832)328429,1462681,909827,66200,328430,156690,228582,2170100,2170101,1965355,192203,12045,1046403)119164,(40979,12472,1432563,1080798,218923,196398,685899,12139,378833,2170592)12137,2560515)2169577)2732506,(((568090,54289,292052,859651,284689,2043550)1511808,(882768,1050903,29257,912029,369643)1511810,(1980625,1980631,348449,1937817,1415665,580254,2759331,2759332,2759333,492502,1756157,425010,2483307,2305257,351495,335204,1768874,1183241,2250452,1310424,2025333,1408894,1685502)37960,(1511847,160484,191436,296210,216371,347482,148880,358008,2083275)1511811,(1323528,1387301,37961,872291,186815,235994)1511809,675060)11012,(114871,2419805)1511860,1187973,2315392)2732549,1961665)2732408,((((284687,607716,399394,1692191,434898,1162393,759389)2560087,(2304034,1405299)2560100,164750)249310,((927810,1167690,1167691,(463392,425009)348097,11008)11007,(1353795,1714364,1714367,1714368,1714370,1755467,1765754,29256,1497848,1921825,1678161,1678165,1678166,1678168,1608533,1678170,1678171,912320,1833938,2026601,2137353,2170548,155414,2082586,2082585,1798085)39756,(196690,(1566868,1460374,1849535,1765736,1728964,1661396,1561171,1561172,1547580,1580605,2268743,1312445)939922,45237,73497,73498)674981,(29255,2082658)11011,(1008292,170965,674953)674952,58103)11006,1000373)2732540,((1427476,1004049,2108203,1807815,1670669,2170578,1640277,907191,352248)2788865,(((559180,2306813,1408137,1955493,1692107)40068,104581,356862,201490,306276,40051,40052,40056,40050,40053,40058,40057,40060,40059,40062,40061,40065,40067,204269,1679172,449133)10892,(10986,10987,10991,411854)10985)2946186,((10989,10990,33724,519497,185954,77698)10988,((1577776,1654361)205909,205899,205908,480410,1382295)10981,(62352,46839)10911,(311228,311229,1840528)311227,2250219,42475)2946187)2732541)2732405,((((((1585246,1608049,1608089,1608100,1608112,1911434,1911435,1803263,1608090,1504569,1027468,1807808,1969830)35303,((1972683,1919071,1479613)1972682,(12538,211977,11292,746543,1072176,249583,38767,38766,237716,57482,57483,642022,1846259)11286,((1288358,1288359)219584,696863)1513299,(1978536,1608119,1608146,1428456,1272953,1408144,318848,318849,2100727,380433,380434,380438,380440,380442,2014931,1537975)1978532,(1972565,1972566,1972567,1972568,1972569,1972570,198833,1344113,11272,11274,11277,11280,290008,50713,239239,1046251)11271,(1550518,1229186,31612,11303,1272960,380160,318834,318835,318836)32613,(1308859,1608066,1608102,1608104,1608114,1608123,(666363,666961)1094373,1002359,1002360,1002361,1002362,1922871,1922889,666962)1308858,(1552661,1620892,1272959)2733246,(1608041,1608137)2842542,(936308,1803034)2842863,(1972612,1972623,1972626,1620895,1158190,1272942,1272943,1272946,1272947,1272949,318845,200401,200402,200403,200404)1972611,(1569258,1491491,318852)2733254,(1256869,170618,685443)1298653,(490110,490111,1620893,380435)1985687,(1987017,1819301,764599,1987020,1987021,1272958,318844)1299306,(1923763,1923772)2560088,(1348439,1620897,1158189,1272957)1985692,(318558,710545,909206)1513300,(2010277,1758878)2733252,936149,1511639,698672,1921414,1620507,1459044,373862,1922904)2842407,((745716,1956177,1064520)1913605,(1608110,1775456)11305,(195060,348823,488317,279896,2908018,59380)2733245,1587515,209854)2842408,(1608067,1608105)2842369,(1923480,1923479)2842367,(1980915,1147160,11290,103603)186778,1923193,1481139)11270,(1923191,1802951,2010272,1608141,1922872)2501985,(1608058,2773460,1608088)2501987,((1608091,1922656)1884458,(1922655,1922653)2501972,1871345)1513294,((2560313,1983777)2560174,(2560327,28274)2560199)2560069,(1926633,1922652)1985709,1923188)11157,(((1577137,1608042,1608044,1608045,1923482,1923773,1608138,1922390,1844927)2507291,(1608099,1922857,1922858)2843020,(1608120,1608121)2842563,(1608133,1758883)2842620,1923358,1608086,1923483,1923484,1922367,1922992)2501952,(1608065,1922862)2842921,1608093,1922937)2499407)2497574,(1923354,1923453,1923647,1923648,1923719,1923771,1938657,1922664)2507497)2497570,(((1048854,1608048,1926501)11584,(1608144,603003,1457166)1980420,(1564120,1851087)2734594)1980418,((1980539,1980540,1608097,1608126,1608127,1931095,1892235,1923003,1923004)1980538,2170595,1608076,1608107,1664810,1664809)1980417,2315803)1980410)2497569,((2138326,1654339)1986418,1918014)1918013)2732396,((1923078,1923081,1923090,1923091,1923092,1923089,1923095,1923094,1923093,1923099,1923102,1923104,1923106,1923107,1923108,1923112,1923111,1923109,1923116,1923117,1923118,1923119,1923121,1923122,1923123,1923132,1923140,1923141,1923143,1923144,1923145,1923146,1923149,1923164,1923168,1923170,1923186,1923195,1923196,1923197,1923200,1923198,1923199,1923203,1923204,1923206,1923208,1923209,1923210,1923214,1923215,1923217,1923218,1923219,1923221,1923223,1923220,1923222,1923241,1923242,1923243,1923244,1923246,1923247,1923248,1923250,1923252,1923253,1923254,1923298,1923300,1923301,1923303,1923305,1923306,1923308,1923307,1923310,1923309,1923313,1923320,1923321,1923324,1923326,1923327,1923330,1923331,1923332,1923333,1923335,1923336,1923338,1923340,1923342,1923350,1923355,1923370,1923377,1923380,1923381,1923382,1923383,1923384,1923394,1923400,1923401,1923404,1923406,1923407,1923405,1923418,1923417,1923419,1923440,1923441,1923447,1923452,1923454,1923463,1923466,1923467,1923468,1923470,1923477,1923488,1923531,1923534,1923535,1923558,1923559,1923562,1923563,1923564,1923584,1923610,1923611,1923612,1923613,1923617,1923619,1923625,1923632,1923634,1923644,1923651,1923654,1923658,1923659,1923660,1923668,1923667,1923679,1923680,1923689,1923691,1923693,1923697,1923698,1923699,1923701,1923703,1923705,1923708,1923709,1923714,1923715,1923710,1923726,1923727,1923730,1923731,1923732,1923736,1923739,1923740,1923741,1923742,1923745,1923751,1923755,1923760,1923761,1923764,1923765,1923768,1923769,1923776,1923778,1923105,1923113,1923114,1923115,1922352,1922356,1922357,1922355,1922360,1922365,1922376,1922378,1922377,1922431,1922432,1922446,1922464,1922471,1922504,1922529,1922528,1922534,1922546,1922547,1922550,1922553,1922566,1922583,1922609,1922611,1922612,1922613,1922614,1922615,1922617,1922618,1922619,1922620,1922621,1922622,1922628,1922633,1922638,1922659,1922672,1922683,1922684,1922688,1922695,1922698,1922708,1922709,1922712,1922724,1922725,1922734,1922736,2170545,1922765,1922767,1922769,1922785,1922784,1922787,1922786,1922794,1922798,1922799,1922833,1922835,1922860,1922866,1922867,1922868,1922870,1922873,1922874,1922877,1922879,1922878,1922898,1922905,1922925,1922926,1922972,1922988,1922989,1922990,1922997,1922998,1922999,1923001,1923002,1923000,1923009,1923012,1923017)1922348,(((1552662,1170422,1170424,1170425,1457165,2094259,1969351,2479372)1307798,2079148,2169477,191289,363716,1088890,1807801,1807803,1500865,1500866,2170589,2170594,1560351)35278,(1608087,2170597)988644,2016467,2016468,1574287,1807762,1807802)439490,2025595,(2081616,2081617)2703870,1133557,1930920,1930921)2585030,(1532031,1849542,1565088,1329781,862943,862944,1848042,1678160,1848169,459770,1211481,2305465,1670975)39780,2320522)2559587,(2480178,2056385,1911102,1755754,1755781,1911438,1585924,1489714,1678208,2010265,2010266,2010268,2010269,2010273,2010274,2010275,2010283,2010284,1897732,1930507,1930508,1930510,1955175,1955196,1955197,1955199,1955198,1807794,1807795,1807799,1654356,1654358,1654359,1654362,1654364,1758881,1758882,1654577,1654579)12429)10239,(7425,((7241,7282)32357,28584)32341)33392);
```

## Planned Improvements
The following improvements are planned for future releases:

- [ ] Automatic choice of the eutils NCBI database
- [ ] Automatic detection of the need for a taxonomy database update
- [ ] Smarter query frequency (i.e., pause time, etc.)
- [ ] Possibility to provide an NCBI API key to make 10 queries per second instead of 3 (max) without a key
- [ ] Parallelization to speed up execution (related to point 4)
- [ ] Options for tree format output
- [ ] Function Documentation


## Dependencies Documentation
The script uses the following external resources:

NCBI eutils API (https://www.ncbi.nlm.nih.gov/books/NBK25500/)
NCBI taxonomy database (https://www.ncbi.nlm.nih.gov/taxonomy)
Taxallnomy website (http://bioinfo.icb.ufmg.br/taxallnomy/) - to get the ordered list of ranks used in the output table.

___

This script was written by DM de Vienne in March 2023. 

If you see a bug, please correct it yourself, :wink: 
